name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "25.2.1"
  RUST_VERSION: "1.92.0"

jobs:
  # =============================================================================
  # 0. Ê£ÄÊü•ÊòØÂê¶Ë∑≥ËøáÔºàÈÅøÂÖçÂæ™ÁéØËß¶ÂèëÔºâ
  # =============================================================================
  check:
    name: Check
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check.outputs.should_skip }}
    steps:
      - name: Check commit message
        id: check
        run: |
          msg="${{ github.event.head_commit.message }}"
          if [[ "$msg" == chore\(release\):* ]]; then
            echo "should_skip=true" >> "$GITHUB_OUTPUT"
            echo "‚è≠Ô∏è Skipping release workflow for release commit"
          else
            echo "should_skip=false" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Proceeding with release workflow"
          fi

  # =============================================================================
  # 1. CI Ê£ÄÊü•
  # =============================================================================
  ci:
    name: CI
    needs: check
    if: needs.check.outputs.should_skip != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ui/package-lock.json

      - name: Build UI
        working-directory: ui
        run: npm ci && npm run build

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Rust fmt
        run: cargo fmt --all -- --check

      - name: Rust clippy
        run: cargo clippy --no-default-features --features embed-ui --all-targets -- -D warnings

      - name: Rust test
        run: cargo test --no-default-features --features embed-ui

      - name: Build
        run: cargo build --release --no-default-features --features embed-ui

  # =============================================================================
  # 2. ÂàÜÊûê commitsÔºåÁ°ÆÂÆöÊòØÂê¶ÈúÄË¶ÅÂèëÂ∏É
  # =============================================================================
  analyze:
    name: Analyze
    needs: [check, ci]
    if: needs.check.outputs.should_skip != 'true'
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.analyze.outputs.should_release }}
      version: ${{ steps.analyze.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Analyze commits
        id: analyze
        run: |
          node scripts/analyze-next-version.mjs

  # =============================================================================
  # 3. ÂáÜÂ§áÂèëÂ∏ÉÔºöÊõ¥Êñ∞ÁâàÊú¨Êñá‰ª∂ + commit + push
  # =============================================================================
  prepare:
    name: Prepare
    needs: analyze
    if: needs.analyze.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.prepare.outputs.tag }}
      version: ${{ steps.prepare.outputs.version }}
      ref: ${{ steps.prepare.outputs.ref }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure git
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update version files
        id: prepare
        env:
          VERSION: ${{ needs.analyze.outputs.version }}
        run: |
          echo "üì¶ Updating to version ${VERSION}"

          # Êõ¥Êñ∞ÁâàÊú¨Êñá‰ª∂
          node scripts/bump-version.mjs "${VERSION}"

          # ÁîüÊàê CHANGELOGÔºàÂè™ËøΩÂä†Êñ∞Êù°ÁõÆÔºâ
          npm install -g conventional-changelog-cli
          conventional-changelog -p conventionalcommits -k ui/package.json -i CHANGELOG.md -s

          # Êèê‰∫§ÂèòÊõ¥
          git add Cargo.toml Cargo.lock ui/package.json ui/package-lock.json CHANGELOG.md
          git commit -m "chore(release): v${VERSION} [skip ci]"
          git push

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=v${VERSION}" >> "$GITHUB_OUTPUT"
          echo "ref=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "‚úÖ Version files updated and pushed"

  # =============================================================================
  # 4. Âπ∂Ë°åÊûÑÂª∫ÂêÑÂπ≥Âè∞
  # =============================================================================
  build_linux_x64:
    name: Linux x64
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libayatana-appindicator3-dev libxdo-dev
          sudo apt-get install -y libwebkit2gtk-4.1-dev || sudo apt-get install -y libwebkit2gtk-4.0-dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ui/package-lock.json

      - name: Build UI
        working-directory: ui
        run: npm ci && npm run build

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build --release

      - name: Package
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          pkg="cliswitch-${VERSION}-linux-x64"
          mkdir -p "dist/${pkg}"
          cp target/release/cliswitch "dist/${pkg}/"
          cp README.md LICENSE "dist/${pkg}/"
          tar -C dist -czf "dist/${pkg}.tar.gz" "${pkg}"
          sha256sum "dist/${pkg}.tar.gz" | cut -d' ' -f1 > "dist/${pkg}.tar.gz.sha256"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: build-linux-x64
          path: dist/*.*

  build_linux_arm64:
    name: Linux ARM64
    needs: prepare
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libayatana-appindicator3-dev libxdo-dev
          sudo apt-get install -y libwebkit2gtk-4.1-dev || sudo apt-get install -y libwebkit2gtk-4.0-dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ui/package-lock.json

      - name: Build UI
        working-directory: ui
        run: npm ci && npm run build

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build --release

      - name: Package
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          pkg="cliswitch-${VERSION}-linux-arm64"
          mkdir -p "dist/${pkg}"
          cp target/release/cliswitch "dist/${pkg}/"
          cp README.md LICENSE "dist/${pkg}/"
          tar -C dist -czf "dist/${pkg}.tar.gz" "${pkg}"
          sha256sum "dist/${pkg}.tar.gz" | cut -d' ' -f1 > "dist/${pkg}.tar.gz.sha256"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: build-linux-arm64
          path: dist/*.*

  build_macos_x64:
    name: macOS x64
    needs: prepare
    runs-on: macos-15-intel
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ui/package-lock.json

      - name: Build UI
        working-directory: ui
        run: npm ci && npm run build

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          pkg="CliSwitch-${VERSION}-macos-x64"
          SKIP_UI=1 bash scripts/bundle-macos-app.sh
          mkdir -p "dist/${pkg}"
          cp -R dist/macos/CliSwitch.app "dist/${pkg}/"
          cp README.md LICENSE "dist/${pkg}/"
          ditto -c -k --sequesterRsrc --keepParent "dist/${pkg}" "dist/${pkg}.zip"
          shasum -a 256 "dist/${pkg}.zip" | cut -d' ' -f1 > "dist/${pkg}.zip.sha256"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: build-macos-x64
          path: dist/*.*

  build_macos_arm64:
    name: macOS ARM64
    needs: prepare
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ui/package-lock.json

      - name: Build UI
        working-directory: ui
        run: npm ci && npm run build

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          pkg="CliSwitch-${VERSION}-macos-arm64"
          SKIP_UI=1 bash scripts/bundle-macos-app.sh
          mkdir -p "dist/${pkg}"
          cp -R dist/macos/CliSwitch.app "dist/${pkg}/"
          cp README.md LICENSE "dist/${pkg}/"
          ditto -c -k --sequesterRsrc --keepParent "dist/${pkg}" "dist/${pkg}.zip"
          shasum -a 256 "dist/${pkg}.zip" | cut -d' ' -f1 > "dist/${pkg}.zip.sha256"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: build-macos-arm64
          path: dist/*.*

  build_windows_x64:
    name: Windows x64
    needs: prepare
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ui/package-lock.json

      - name: Build UI
        working-directory: ui
        run: npm ci && npm run build

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build --release --target x86_64-pc-windows-msvc

      - name: Package
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        shell: pwsh
        run: |
          $pkg = "CliSwitch-$env:VERSION-windows-x64"
          New-Item -ItemType Directory -Path "dist\$pkg" -Force | Out-Null
          Copy-Item "target\x86_64-pc-windows-msvc\release\cliswitch.exe" "dist\$pkg\CliSwitch.exe"
          Copy-Item "README.md","LICENSE" "dist\$pkg\"
          Compress-Archive -Path "dist\$pkg" -DestinationPath "dist\$pkg.zip" -Force
          $hash = (Get-FileHash -Algorithm SHA256 "dist\$pkg.zip").Hash.ToLower()
          $hash | Out-File -FilePath "dist\$pkg.zip.sha256" -Encoding utf8 -NoNewline

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: build-windows-x64
          path: dist/*.*

  build_windows_arm64:
    name: Windows ARM64
    needs: prepare
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ui/package-lock.json

      - name: Build UI
        working-directory: ui
        run: npm ci && npm run build

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-pc-windows-msvc

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build --release --target aarch64-pc-windows-msvc

      - name: Package
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        shell: pwsh
        run: |
          $pkg = "CliSwitch-$env:VERSION-windows-arm64"
          New-Item -ItemType Directory -Path "dist\$pkg" -Force | Out-Null
          Copy-Item "target\aarch64-pc-windows-msvc\release\cliswitch.exe" "dist\$pkg\CliSwitch.exe"
          Copy-Item "README.md","LICENSE" "dist\$pkg\"
          Compress-Archive -Path "dist\$pkg" -DestinationPath "dist\$pkg.zip" -Force
          $hash = (Get-FileHash -Algorithm SHA256 "dist\$pkg.zip").Hash.ToLower()
          $hash | Out-File -FilePath "dist\$pkg.zip.sha256" -Encoding utf8 -NoNewline

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: build-windows-arm64
          path: dist/*.*

  # =============================================================================
  # 5. ÂèëÂ∏ÉÔºöÂàõÂª∫ tag + Release + ‰∏ä‰º† assetsÔºàÂéüÂ≠êÊìç‰ΩúÔºâ
  # =============================================================================
  publish:
    name: Publish
    needs:
      - prepare
      - build_linux_x64
      - build_linux_arm64
      - build_macos_x64
      - build_macos_arm64
      - build_windows_x64
      - build_windows_arm64
    if: |
      always() &&
      needs.prepare.result == 'success' &&
      needs.build_linux_x64.result == 'success' &&
      needs.build_linux_arm64.result == 'success' &&
      needs.build_macos_x64.result == 'success' &&
      needs.build_macos_arm64.result == 'success' &&
      needs.build_windows_x64.result == 'success' &&
      needs.build_windows_arm64.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: build-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la dist/

      - name: Create tag
        env:
          TAG: ${{ needs.prepare.outputs.tag }}
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${TAG}" -m "Release ${TAG}"
          git push origin "${TAG}"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: ${{ needs.prepare.outputs.tag }}
          generate_release_notes: true
          files: dist/*
